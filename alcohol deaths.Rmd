---
title: "Alcohol deaths"
author: "Beth Jump"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### set up the environment
```{r }
# check to see the default library that's set
.libPaths()

# can select the primary libpath using: 
.libPaths(.libPaths()[2])

# install and save these packages:
install.packages(c("icd", "stringr", "dplyr", "sas7bdat", "eeptools"))
library("icd") 
library("stringr") 
library("dplyr")
library("sas7bdat")
library("eeptools")
```

## set up file paths you'll need:
```{r}
# file paths for: location of resident death dataset, location to save deaths with primary code K70, location to save deaths with K70 or text for alcohol and location to save deaths with primary code, text or multiple code K70
res_path <- ""
prim_code <- ""
prim_code_or_text <- ""
any_code_or_text <- ""
```

# read in cleaned data sets that you created using a cleaning script (either VRBIS or VRBIS + MCOD)
```{r}
comb_deaths <- read.csv(res_path)
```

# do some additional cleaning so the following steps work
```{r}
# make the icd 10 number field only 2 characters
comb_deaths$icd_num <- substring(comb_deaths$icd_num,1,2)

# make sure the multiple cause codes only have three characters 
comb_deaths$ra1 <- as.character(substring(comb_deaths$ra1,1,3)) 
comb_deaths$ra2 <- as.character(substring(comb_deaths$ra2,1,3)) 
comb_deaths$ra3 <- as.character(substring(comb_deaths$ra3,1,3)) 
comb_deaths$ra4 <- as.character(substring(comb_deaths$ra4,1,3)) 
comb_deaths$ra5 <- as.character(substring(comb_deaths$ra5,1,3)) 
comb_deaths$ra6 <- as.character(substring(comb_deaths$ra6,1,3)) 
comb_deaths$ra7 <- as.character(substring(comb_deaths$ra7,1,3)) 
comb_deaths$ra8 <- as.character(substring(comb_deaths$ra8,1,3)) 
comb_deaths$ra9 <- as.character(substring(comb_deaths$ra9,1,3)) 
comb_deaths$ra10 <- as.character(substring(comb_deaths$ra10,1,3)) 
comb_deaths$ra11 <- as.character(substring(comb_deaths$ra11,1,3)) 
```

# look at alcohol deaths by underlying cause only
```{r}
# find deaths that have an underlying cause of K70.x (alcoholic liver disease)
comb_deaths$alcohol <- NA
comb_deaths$alcohol <- ifelse(comb_deaths$icd_char == "K" & comb_deaths$icd_num == 70, 1, comb_deaths$alcohol)

# make a new data frame with only those deaths
alc_codes <- comb_deaths[!is.na(comb_deaths$alcohol),]
```

# look at alcohol deaths by keywords
```{r}
alc_key <- c("alcoholic liver disease", "alcohol cirrhosis", "ethanol", "alcoholism", "ethanolism", "ethyl alcohol", "chronic alcohol", "chronic ethanol", "acute alcohol", "acute ethanol", "alcohol dependence", "ethanol dependence", "alcohol abuse", "ethanol abuse", "alcohol intoxication", "ethanol intoxication", "ethanol toxicity", "alcoholic dementia", "alcohol dependency", "ethanol dependency", "alcohol withdrawal", "alcoholic consumption", "due to alcohol", "due to ethanol")

# look at the first cause of death field for keywords related to alcohol deaths
alc_135 <- comb_deaths[grep(paste(alc_key,collapse="|"), comb_deaths$causeOfDeath_135, ignore.case = T),]
alc_137 <- comb_deaths[grep(paste(alc_key,collapse="|"), comb_deaths$causeOfDeath1_137, ignore.case = T),]
alc_139 <- comb_deaths[grep(paste(alc_key,collapse="|"), comb_deaths$causeOfDeath2_139, ignore.case = T),]
alc_141 <- comb_deaths[grep(paste(alc_key,collapse="|"), comb_deaths$causeOfDeath3_141, ignore.case = T),]
alc_151 <- comb_deaths[grep(paste(alc_key,collapse="|"), comb_deaths$otherSigCond_151, ignore.case = T),]

# combine all together to get a list of all deaths with a reference to alcohol in the description
alc_text <- rbind(alc_135, alc_137, alc_139, alc_141, alc_151, stringsAsFactors = F)

# get rid of duplicates
alc_text <- unique(alc_text)
```

# identify deaths with a K70 in any of the multiple cause fields
```{r}
alcohol_K70 <- comb_deaths[(comb_deaths$ra1 == "K70" | comb_deaths$ra2 == "K70" | comb_deaths$ra3 == "K70" | comb_deaths$ra4 == "K70" | comb_deaths$ra5 == "K70" | comb_deaths$ra6 == "K70" | comb_deaths$ra7 == "K70" | comb_deaths$ra8 == "K70" | comb_deaths$ra9 == "K70" | comb_deaths$ra10 == "K70" | comb_deaths$ra11 == "K70"),]
```

# look at alcohol deaths by underlying code and keyword and multiple cause code
```{r}
alc_code_or_text <- rbind(alc_codes, alc_text, stringsAsFactors = F)

alc_comb <- rbind(alc_code_or_text, alcohol_K70, stringsAsFactors = F)

# use unique function to get rid of duplicates
alc_comb_final <- unique(alc_comb)
```

# split into 6 month increments
```{r}
# residents with underlying code K70, K73, K74
code_jan <- alc_codes[(alc_codes$deathmo >=1 & alc_codes$deathmo <=6),]
code_jul <- alc_codes[(alc_codes$deathmo >=7 & alc_codes$deathmo <=12),]
  
# residents with underlying + text
codetext_jan <- alc_code_or_text[(alc_code_or_text$deathmo >=1 & alc_code_or_text$deathmo <=6),]
codetext_jul <- alc_code_or_text[(alc_code_or_text$deathmo >=7 & alc_code_or_text$deathmo <=12),]

# residents with underlying + text + mcod 
codetmcod_jan <- alc_comb_final[(alc_comb_final$deathmo >=1 & alc_comb_final$deathmo <=6),]
codetmcod_jul <- alc_comb_final[(alc_comb_final$deathmo >=7 & alc_comb_final$deathmo <=12),]
```

# create files with deaths identified above 
```{r}
write.csv(alc_codes, prim_code)
write.csv(alc_code_or_text, prim_code_or_text)
write.csv(alc_comb_final, any_code_or_text)
```
